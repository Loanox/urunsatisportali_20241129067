@model urunsatisportali.Models.Sale
@using urunsatisportali.Helpers
@{
    ViewData["Title"] = "Yeni Satış";
    Layout = "_AdminLayout";
    var nonce = Context.Items["CSPNonce"] as string ?? "";
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2><i class="bi bi-plus-circle"></i> Yeni Satış</h2>
    <a asp-action="Index" class="btn btn-secondary"><i class="bi bi-arrow-left"></i> Geri</a>
</div>

<div class="card">
    <div class="card-body">
        <form id="saleForm" method="post" asp-action="Create" asp-controller="Sales" novalidate>
            @Html.AntiForgeryToken()
            <div id="formAlert" class="alert d-none" role="alert"></div>
            @if (!ViewData.ModelState.IsValid)
            {
                <div class="alert alert-danger">
                    <ul class="mb-0">
                        @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
                        {
                            <li>@error.ErrorMessage</li>
                        }
                    </ul>
                </div>
            }

            <div class="row g-3 mb-2">
                <div class="col-md-6">
                    <label for="CustomerId" class="form-label">Müşteri <span class="text-danger">*</span></label>
                    <select id="CustomerId" name="CustomerId" class="form-select" required>
                        <option value="">Müşteri Seçin</option>
                        @if (ViewBag.Customers != null)
                        {
                            @foreach (var customer in (List<urunsatisportali.Models.Customer>)ViewBag.Customers)
                            {
                                <option value="@customer.Id">@customer.Name</option>
                            }
                        }
                    </select>
                    <div class="form-text">Satışın bağlanacağı müşteri.</div>
                    <span id="CustomerIdError" class="text-danger"></span>
                </div>
                <div class="col-md-3">
                    <label for="Discount" class="form-label">İndirim (%)</label>
                    <input id="Discount" name="Discount" type="number" step="0.01" class="form-control" value="0" />
                    <span id="DiscountError" class="text-danger"></span>
                </div>
                <div class="col-md-3">
                    <label for="Tax" class="form-label">Vergi (%)</label>
                    <input id="Tax" name="Tax" type="number" step="0.01" class="form-control" value="0" />
                    <span id="TaxError" class="text-danger"></span>
                </div>
            </div>

            <div class="mb-3">
                <label for="Notes" class="form-label">Notlar</label>
                <textarea id="Notes" name="Notes" class="form-control" rows="2"
                    placeholder="Opsiyonel not ekleyin"></textarea>
                <span id="NotesError" class="text-danger"></span>
            </div>

            <hr />

            <h5 class="mb-2">Ürün Kalemleri</h5>
            <div id="saleItems">
                <div class="row g-2 mb-2 sale-item">
                    <div class="col-md-6">
                        <label class="form-label">Ürün <span class="text-danger">*</span></label>
                        <select name="productIds[]" class="form-select product-select" required>
                            <option value="">Ürün Seçin</option>
                            @if (ViewBag.Products != null)
                            {
                                @foreach (var product in (List<urunsatisportali.Models.Product>)ViewBag.Products)
                                {
                                    <option value="@product.Id"
                                        data-price="@product.Price.ToString(System.Globalization.CultureInfo.InvariantCulture)"
                                        data-stock="@product.StockQuantity">
                                        @product.Name - @CurrencyHelper.FormatTurkishLira(product.Price) (Stok:
                                        @product.StockQuantity)
                                    </option>
                                }
                            }
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Adet <span class="text-danger">*</span></label>
                        <input type="number" name="quantities[]" class="form-control quantity-input" placeholder="Adet"
                            min="1" required />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Toplam</label>
                        <input type="text" class="form-control item-total" readonly placeholder="0.00 ₺" />
                    </div>
                    <div class="col-md-1 d-flex align-items-end">
                        <button type="button" class="btn btn-danger remove-item" title="Kalemi kaldır"><i
                                class="bi bi-trash3"></i></button>
                    </div>
                </div>
            </div>

            <button type="button" class="btn btn-warning mb-3" id="addItem">
                <i class="bi bi-plus-circle"></i> Kalem Ekle
            </button>

            <div class="row">
                <div class="col-md-6">
                    <div class="card bg-light">
                        <div class="card-body">
                            <h6>Satış Özeti</h6>
                            <dl class="row mb-0">
                                <dt class="col-sm-6">Ara Toplam</dt>
                                <dd class="col-sm-6" id="subtotal">0.00 ₺</dd>
                                <dt class="col-sm-6">Vergi</dt>
                                <dd class="col-sm-6" id="taxAmount">0.00 ₺</dd>
                                <dt class="col-sm-6">İndirim</dt>
                                <dd class="col-sm-6" id="discount">0.00 ₺</dd>
                                <dt class="col-sm-6"><strong>Genel Toplam</strong></dt>
                                <dd class="col-sm-6"><strong id="total">0.00 ₺</strong></dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>

            <div class="d-flex justify-content-between mt-3">
                <a asp-action="Index" class="btn btn-secondary"><i class="bi bi-x-circle"></i> İptal</a>
                <button type="submit" id="submitSale" class="btn btn-primary">
                    <span id="submitText">Satışı Oluştur</span>
                </button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script nonce="@nonce">
        $(function () {
            function recalcItem(item) {
                var qty = parseFloat(item.find('.quantity-input').val()) || 0;
                var price = parseFloat(item.find('.product-select option:selected').data('price')) || 0;
                var total = qty * price;
                item.find('.item-total').val(total.toFixed(2) + ' ₺');
                recalcTotals();
            }
            function formatCurrency(v) { return v.toFixed(2) + ' ₺'; }
            function recalcTotals() {
                var subtotal = 0;
                $('.item-total').each(function () {
                    var txt = $(this).val();
                    var num = parseFloat(txt);
                    subtotal += isNaN(num) ? 0 : num;
                });
                var taxPercent = parseFloat($('#Tax').val()) || 0;
                var discountPercent = parseFloat($('#Discount').val()) || 0;
                var taxAmount = subtotal * (taxPercent / 100.0);
                var discountAmount = subtotal * (discountPercent / 100.0);
                var total = subtotal + taxAmount - discountAmount;
                $('#subtotal').text(formatCurrency(subtotal));
                $('#taxAmount').text(formatCurrency(taxAmount));
                $('#discount').text(formatCurrency(discountAmount));
                $('#total').text(formatCurrency(total));
            }
            $('#addItem').click(function () {
                var newItem = $('.sale-item').first().clone();
                newItem.find('input').val('');
                newItem.find('select').val('');
                newItem.find('.item-total').val('0.00 ₺');
                newItem.find('select.product-select').attr('name', 'productIds[]');
                newItem.find('input.quantity-input').attr('name', 'quantities[]');
                $('#saleItems').append(newItem);
                recalcTotals();
            });
            $(document).on('click', '.remove-item', function () {
                if ($('.sale-item').length > 1) { $(this).closest('.sale-item').remove(); recalcTotals(); }
            });
            $(document).on('change', '.product-select', function () { recalcItem($(this).closest('.sale-item')); });
            $(document).on('input', '.quantity-input', function () { recalcItem($(this).closest('.sale-item')); });
            $(document).on('input', '#Discount, #Tax', function () { recalcTotals(); });

            // Simplified form submission for this step without complex AJAX handling
            // Controller will handle redirects
        });
    </script>
}
