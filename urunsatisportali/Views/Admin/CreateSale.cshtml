@model urunsatisportali.Models.Sale
@{
    ViewData["Title"] = "Create Sale";
    Layout = "_AdminLayout";
}

<div class="page-header">
    <h2><i class="bi bi-plus-circle"></i> Create New Sale</h2>
</div>

<div class="card">
    <div class="card-body">
        <form asp-action="CreateSale" method="post" id="saleForm">
            <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <label asp-for="CustomerId" class="form-label">Customer *</label>
                    <select asp-for="CustomerId" class="form-select" required>
                        <option value="">Select Customer</option>
                        @foreach (var customer in (List<urunsatisportali.Models.Customer>)ViewBag.Customers)
                        {
                            <option value="@customer.Id">@customer.Name</option>
                        }
                    </select>
                    <span asp-validation-for="CustomerId" class="text-danger"></span>
                </div>

                <div class="col-md-3">
                    <label asp-for="Discount" class="form-label">Discount</label>
                    <input asp-for="Discount" type="number" step="0.01" class="form-control" value="0" />
                    <span asp-validation-for="Discount" class="text-danger"></span>
                </div>

                <div class="col-md-3">
                    <label asp-for="Tax" class="form-label">Tax</label>
                    <input asp-for="Tax" type="number" step="0.01" class="form-control" value="0" />
                    <span asp-validation-for="Tax" class="text-danger"></span>
                </div>
            </div>

            <div class="mb-3">
                <label asp-for="Notes" class="form-label">Notes</label>
                <textarea asp-for="Notes" class="form-control" rows="2"></textarea>
                <span asp-validation-for="Notes" class="text-danger"></span>
            </div>

            <hr />

            <h5>Sale Items</h5>
            <div id="saleItems">
                <div class="row mb-2 sale-item">
                    <div class="col-md-5">
                        <select name="productIds" class="form-select product-select" required>
                            <option value="">Select Product</option>
                            @foreach (var product in (List<urunsatisportali.Models.Product>)ViewBag.Products)
                            {
                                <option value="@product.Id" data-price="@product.Price" data-stock="@product.StockQuantity">
                                    @product.Name - @product.Price.ToString("C") (Stock: @product.StockQuantity)
                                </option>
                            }
                        </select>
                    </div>
                    <div class="col-md-2">
                        <input type="number" name="quantities" class="form-control quantity-input" placeholder="Qty" min="1" required />
                    </div>
                    <div class="col-md-2">
                        <input type="number" name="unitPrices" class="form-control price-input" step="0.01" placeholder="Price" required />
                    </div>
                    <div class="col-md-2">
                        <input type="text" class="form-control item-total" readonly placeholder="Total" />
                    </div>
                    <div class="col-md-1">
                        <button type="button" class="btn btn-danger remove-item"><i class="bi bi-trash"></i></button>
                    </div>
                </div>
            </div>

            <button type="button" class="btn btn-secondary mb-3" id="addItem">
                <i class="bi bi-plus-circle"></i> Add Item
            </button>

            <hr />

            <div class="row">
                <div class="col-md-6">
                    <div class="card bg-light">
                        <div class="card-body">
                            <h6>Sale Summary</h6>
                            <dl class="row mb-0">
                                <dt class="col-sm-6">Subtotal:</dt>
                                <dd class="col-sm-6" id="subtotal">$0.00</dd>
                                <dt class="col-sm-6">Discount:</dt>
                                <dd class="col-sm-6" id="discount">$0.00</dd>
                                <dt class="col-sm-6">Tax:</dt>
                                <dd class="col-sm-6" id="tax">$0.00</dd>
                                <dt class="col-sm-6"><strong>Total:</strong></dt>
                                <dd class="col-sm-6"><strong id="total">$0.00</strong></dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>

            <div class="d-flex justify-content-between mt-3">
                <a asp-action="Sales" class="btn btn-secondary">Cancel</a>
                <button type="submit" class="btn btn-primary">Create Sale</button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        $(document).ready(function() {
            // Add new item row
            $('#addItem').click(function() {
                var newItem = $('.sale-item').first().clone();
                newItem.find('input, select').val('');
                newItem.find('.item-total').val('');
                $('#saleItems').append(newItem);
            });

            // Remove item row
            $(document).on('click', '.remove-item', function() {
                if ($('.sale-item').length > 1) {
                    $(this).closest('.sale-item').remove();
                    calculateTotal();
                }
            });

            // Product selection - auto-fill price
            $(document).on('change', '.product-select', function() {
                var selectedOption = $(this).find('option:selected');
                var price = selectedOption.data('price');
                var stock = selectedOption.data('stock');
                $(this).closest('.sale-item').find('.price-input').val(price);
                $(this).closest('.sale-item').find('.quantity-input').attr('max', stock);
                calculateItemTotal($(this).closest('.sale-item'));
            });

            // Calculate item total
            $(document).on('input', '.quantity-input, .price-input', function() {
                calculateItemTotal($(this).closest('.sale-item'));
            });

            // Calculate discount and tax
            $(document).on('input', '#Discount, #Tax', function() {
                calculateTotal();
            });

            function calculateItemTotal(item) {
                var quantity = parseFloat(item.find('.quantity-input').val()) || 0;
                var price = parseFloat(item.find('.price-input').val()) || 0;
                var total = quantity * price;
                item.find('.item-total').val(total.toFixed(2));
                calculateTotal();
            }

            function calculateTotal() {
                var subtotal = 0;
                $('.item-total').each(function() {
                    subtotal += parseFloat($(this).val()) || 0;
                });

                var discount = parseFloat($('#Discount').val()) || 0;
                var tax = parseFloat($('#Tax').val()) || 0;
                var total = subtotal - discount + tax;

                $('#subtotal').text('$' + subtotal.toFixed(2));
                $('#discount').text('$' + discount.toFixed(2));
                $('#tax').text('$' + tax.toFixed(2));
                $('#total').text('$' + total.toFixed(2));
            }
        });
    </script>
}

