@model urunsatisportali.Models.Product
@{
    ViewData["Title"] = Model.Name;
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="row">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-body">
                <div class="row gx-lg-5">
                    <div class="col-xl-4 col-md-8 mx-auto">
                        <div class="product-img-slider sticky-side-div">
                            <div class="swiper product-thumbnail-slider p-2 rounded bg-light">
                                <div class="swiper-wrapper">
                                    @if (Model.Images != null && Model.Images.Any())
                                    {
                                        foreach (var img in Model.Images)
                                        {
                                            <div class="swiper-slide">
                                                <img src="@img.ImageUrl" alt="" class="img-fluid d-block" style="max-height: 400px; margin: 0 auto;" />
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                         <div class="swiper-slide">
                                            <img src="~/assets/images/products/img-1.png" alt="" class="img-fluid d-block" />
                                        </div>
                                    }
                                </div>
                                <div class="swiper-button-next"></div>
                                <div class="swiper-button-prev"></div>
                            </div>
                        </div>
                    </div>
                    <!-- end col -->

                    <div class="col-xl-8">
                        <div class="mt-xl-0 mt-5">
                            <div class="d-flex">
                                <div class="flex-grow-1">
                                    <h4>@Model.Name</h4>
                                    <div class="hstack gap-3 flex-wrap">
                                        <div class="text-muted">Brand: <a href="#" class="text-primary fw-medium">@(Model.Brand ?? "Genel")</a></div>
                                        <div class="vr"></div>
                                        <div class="text-muted">Published : <span class="text-body fw-medium">@Model.CreatedAt.ToString("dd MMM, yyyy")</span></div>
                                    </div>
                                </div>
                                <div class="flex-shrink-0">
                                    @if (User.IsInRole("Admin") || User.IsInRole("Owner"))
                                    {
                                        <div>
                                            <a href="@Url.Action("Edit", "Products", new { id = Model.Id })" class="btn btn-light" data-bs-toggle="tooltip" data-bs-placement="top" title="Edit"><i class="ri-pencil-fill align-bottom"></i></a>
                                        </div>
                                    }
                                </div>
                            </div>

                            <div class="row mt-4">
                                <div class="col-lg-3 col-sm-6">
                                    <div class="p-2 border border-dashed rounded">
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-sm me-2">
                                                <div class="avatar-title rounded bg-transparent text-success fs-24">
                                                    <i class="ri-money-dollar-circle-fill"></i>
                                                </div>
                                            </div>
                                            <div class="flex-grow-1">
                                                <p class="text-muted mb-1">Price :</p>
                                                <h5 class="mb-0">@Model.Price.ToString("C2")</h5>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-4 text-muted">
                                <h5 class="fs-14">Description :</h5>
                                <p>@Model.Description</p>
                            </div>

                            <div class="row align-items-end g-4 mt-5">
                                <div class="col-xl-6">
                                    <div class="d-flex gap-2">
                                        @if (Model.StockQuantity > 0)
                                        {
                                            <form asp-controller="Cart" asp-action="AddToCart" method="post" class="d-inline" id="addToCartForm">
                                                <input type="hidden" name="productId" value="@Model.Id" />
                                                <button type="submit" class="btn btn-success"><i class="ri-shopping-cart-2-fill align-bottom me-1"></i> Add to Cart</button>
                                            </form>
                                            
                                            <form asp-controller="Cart" asp-action="AddToCart" method="post" class="d-inline">
                                                <input type="hidden" name="productId" value="@Model.Id" />
                                                <input type="hidden" name="returnUrl" value="@Url.Action("Index", "Checkout")" />
                                                <button type="submit" class="btn btn-secondary">Buy Now</button>
                                            </form>
                                        }
                                        else
                                        {
                                            <button type="button" class="btn btn-danger" disabled><i class="ri-close-circle-fill align-bottom me-1"></i> Out of Stock</button>
                                        }
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                    <!-- end col -->
                </div>
                <!-- end row -->
            </div>
            <!-- end card body -->
        </div>
        <!-- end card -->

        <!-- Related Products -->
        @if (ViewBag.RelatedProducts != null)
        {
            <div class="row mt-5">
                 <div class="col-lg-12">
                     <h5 class="mb-3">Related Products</h5>
                     <div class="row">
                        @foreach (var item in (IEnumerable<urunsatisportali.Models.Product>)ViewBag.RelatedProducts)
                        {
                            <div class="col-xl-3 col-sm-6">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="product-img position-relative rounded overflow-hidden">
                                             @{
                                                var firstImg = item.Images?.FirstOrDefault()?.ImageUrl ?? "/assets/images/products/img-1.png";
                                            }
                                            <img src="@firstImg" alt="" class="img-fluid mx-auto d-block" style="height: 200px; object-fit: contain;">
                                        </div>
                                        <div class="mt-3">
                                            <h5 class="mb-1 text-truncate"><a href="@Url.Action("Details", "Shop", new { id = item.Id })" class="text-dark">@item.Name</a></h5>
                                            <h6 class="text-muted fw-normal text-truncate-two-lines mb-0">@item.Brand</h6>
                                        </div>
                                        <div class="mt-3 hstack gap-2 justify-content-between align-items-center">
                                            <h5 class="mb-0 text-primary">@item.Price.ToString("C2")</h5>
                                            <a href="@Url.Action("Details", "Shop", new { id = item.Id })" class="btn btn-sm btn-soft-primary">View</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                     </div>
                 </div>
            </div>
        }

    </div>
    <!-- end col -->
</div>
<!-- end row -->

@section Scripts {
    <!-- Toastify css -->
    <link rel="stylesheet" type="text/css" href="~/assets/libs/toastify-js/src/toastify.css">
    <!-- Toastify js -->
    <script src="~/assets/libs/toastify-js/src/toastify.js"></script>

    <script>
        document.getElementById('addToCartForm').addEventListener('submit', function(e) {
            e.preventDefault();
            var form = this;
            var button = form.querySelector('button[type="submit"]');
            var originalText = button.innerHTML;
            
            button.disabled = true;
            button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Adding...';

            fetch(form.action, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: new URLSearchParams(new FormData(form))
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update all badge counters
                    document.querySelectorAll('.cartitem-badge').forEach(function(el) {
                        el.innerText = data.cartCount;
                    });

                    Toastify({
                        text: "Product added to cart!",
                        duration: 3000,
                        close: true,
                        gravity: "top", // `top` or `bottom`
                        position: "right", // `left`, `center` or `right`
                        stopOnFocus: true, // Prevents dismissing of toast on hover
                        style: {
                            background: "linear-gradient(to right, #0ab39c, #405189)",
                        },
                    }).showToast();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Toastify({
                   text: "Error adding to cart.",
                   duration: 3000,
                   close: true,
                   style: { background: "#f06548" }
                }).showToast();
            })
            .finally(() => {
                button.disabled = false;
                button.innerHTML = originalText;
            });
        });
    </script>
}
